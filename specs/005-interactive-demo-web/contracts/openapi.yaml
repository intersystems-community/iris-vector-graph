openapi: 3.0.3
info:
  title: IRIS Interactive Demo API
  description: |
    Demo web server showcasing IRIS capabilities for Financial Services (fraud detection)
    and Biomedical Research (protein networks). Provides live queries, bitemporal time-travel,
    network visualization, and hybrid search demonstrations.
  version: 1.0.0
  contact:
    name: IRIS Demo Team

servers:
  - url: http://localhost:8200
    description: Local demo server

tags:
  - name: fraud
    description: Financial Services fraud detection endpoints
  - name: biomedical
    description: Biomedical research protein network endpoints
  - name: session
    description: Demo session management

paths:
  # ========================================
  # FRAUD DETECTION ENDPOINTS
  # ========================================

  /api/fraud/score:
    post:
      tags: [fraud]
      summary: Score transaction for fraud probability
      description: |
        Submit transaction details for real-time fraud scoring (FR-006, FR-007).
        Returns fraud probability with human-readable risk classification within 2 seconds (FR-002).
      operationId: scoreFraudTransaction
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FraudTransactionQuery'
      responses:
        '200':
          description: Fraud scoring result
          content:
            application/json:
              schema:
                type: object
                properties:
                  result:
                    $ref: '#/components/schemas/FraudScoringResult'
                  metrics:
                    $ref: '#/components/schemas/QueryPerformanceMetrics'
        '400':
          $ref: '#/components/responses/ValidationError'
        '503':
          $ref: '#/components/responses/ServiceUnavailable'

  /api/fraud/bitemporal:
    post:
      tags: [fraud]
      summary: Time-travel query ("what did we know when?")
      description: |
        Retrieve historical transaction state as it appeared at specific timestamp (FR-008).
        Supports bitemporal queries with system-time and valid-time.
      operationId: bitemporalQuery
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BitemporalQuery'
      responses:
        '200':
          description: Historical transaction state
          content:
            application/json:
              schema:
                type: object
                properties:
                  result:
                    $ref: '#/components/schemas/BitemporalResult'
                  metrics:
                    $ref: '#/components/schemas/QueryPerformanceMetrics'
        '400':
          $ref: '#/components/responses/ValidationError'
        '404':
          description: Event not found

  /api/fraud/audit/{event_id}:
    get:
      tags: [fraud]
      summary: Get complete audit trail for transaction
      description: |
        Display all versions of transaction showing who changed what and when (FR-009).
        Returns complete version history with reasons for changes.
      operationId: getAuditTrail
      parameters:
        - name: event_id
          in: path
          required: true
          schema:
            type: string
          description: Transaction identifier
      responses:
        '200':
          description: Complete audit trail
          content:
            application/json:
              schema:
                type: object
                properties:
                  event_id:
                    type: string
                  versions:
                    type: array
                    items:
                      $ref: '#/components/schemas/BitemporalVersion'
                  metrics:
                    $ref: '#/components/schemas/QueryPerformanceMetrics'
        '404':
          description: Transaction not found

  /api/fraud/late-arrivals:
    get:
      tags: [fraud]
      summary: Detect late-arriving transactions
      description: |
        Find transactions reported >24 hours after occurrence (FR-010).
        Highlights suspicious settlement delay patterns.
      operationId: getLateArrivals
      parameters:
        - name: delay_threshold_hours
          in: query
          schema:
            type: integer
            default: 24
          description: Minimum delay in hours to flag as late arrival
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
            maximum: 100
      responses:
        '200':
          description: Late-arriving transactions
          content:
            application/json:
              schema:
                type: object
                properties:
                  results:
                    type: array
                    items:
                      $ref: '#/components/schemas/LateArrivalTransaction'
                  total_count:
                    type: integer
                  metrics:
                    $ref: '#/components/schemas/QueryPerformanceMetrics'

  # ========================================
  # BIOMEDICAL ENDPOINTS
  # ========================================

  /api/bio/search:
    post:
      tags: [biomedical]
      summary: Search for proteins by name or identifier
      description: |
        Search proteins using vector similarity, text search, or hybrid (FR-013, FR-014).
        Returns top-k results ranked by similarity score.
      operationId: searchProteins
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProteinQuery'
      responses:
        '200':
          description: Protein search results
          content:
            application/json:
              schema:
                type: object
                properties:
                  results:
                    type: array
                    items:
                      $ref: '#/components/schemas/ProteinSearchResult'
                  total_count:
                    type: integer
                  metrics:
                    $ref: '#/components/schemas/QueryPerformanceMetrics'
        '400':
          $ref: '#/components/responses/ValidationError'

  /api/bio/pathway:
    post:
      tags: [biomedical]
      summary: Find pathway between two proteins
      description: |
        Compute multi-hop pathway showing protein interactions (FR-016).
        Returns shortest path or all paths up to max_hops.
      operationId: findPathway
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PathwayQuery'
      responses:
        '200':
          description: Protein interaction pathway
          content:
            application/json:
              schema:
                type: object
                properties:
                  pathway:
                    type: array
                    items:
                      type: object
                      properties:
                        protein_id:
                          type: string
                        protein_name:
                          type: string
                        hop_number:
                          type: integer
                  network:
                    $ref: '#/components/schemas/InteractionNetwork'
                  metrics:
                    $ref: '#/components/schemas/QueryPerformanceMetrics'
        '404':
          description: No pathway found

  /api/bio/hybrid-search:
    post:
      tags: [biomedical]
      summary: Hybrid search (vector + text + RRF fusion)
      description: |
        Demonstrate hybrid search combining semantic similarity and text keywords (FR-017).
        Returns fused results with explanation of ranking method.
      operationId: hybridSearch
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                query_text:
                  type: string
                  description: Text query for BM25 search
                query_vector:
                  type: array
                  items:
                    type: number
                  description: Vector embedding for similarity search (optional)
                top_k:
                  type: integer
                  default: 10
                  maximum: 100
              required:
                - query_text
      responses:
        '200':
          description: Hybrid search results with RRF fusion
          content:
            application/json:
              schema:
                type: object
                properties:
                  results:
                    type: array
                    items:
                      $ref: '#/components/schemas/ProteinSearchResult'
                  fusion_explanation:
                    type: object
                    properties:
                      vector_results:
                        type: integer
                      text_results:
                        type: integer
                      rrf_k:
                        type: number
                  metrics:
                    $ref: '#/components/schemas/QueryPerformanceMetrics'

  /api/bio/network/{protein_id}/expand:
    get:
      tags: [biomedical]
      summary: Expand protein node to show interaction partners
      description: |
        Load additional protein neighbors for network visualization (FR-018).
        Supports progressive disclosure in graph UI.
      operationId: expandProteinNode
      parameters:
        - name: protein_id
          in: path
          required: true
          schema:
            type: string
        - name: max_neighbors
          in: query
          schema:
            type: integer
            default: 20
            maximum: 100
      responses:
        '200':
          description: Neighboring proteins and interactions
          content:
            application/json:
              schema:
                type: object
                properties:
                  neighbors:
                    type: array
                    items:
                      $ref: '#/components/schemas/ProteinNode'
                  edges:
                    type: array
                    items:
                      $ref: '#/components/schemas/InteractionEdge'
                  metrics:
                    $ref: '#/components/schemas/QueryPerformanceMetrics'

  # ========================================
  # SESSION MANAGEMENT ENDPOINTS
  # ========================================

  /api/session/switch-mode:
    post:
      tags: [session]
      summary: Switch between fraud and biomedical demo modes
      description: |
        Switch demo mode while preserving query history (FR-021).
      operationId: switchMode
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                mode:
                  type: string
                  enum: [fraud, biomedical]
              required:
                - mode
      responses:
        '200':
          description: Mode switched successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  new_mode:
                    type: string
                  query_history_preserved:
                    type: boolean

  /api/session/history:
    get:
      tags: [session]
      summary: Get query history for current session
      description: |
        Retrieve all queries performed in session (FR-003).
      operationId: getQueryHistory
      responses:
        '200':
          description: Query history
          content:
            application/json:
              schema:
                type: object
                properties:
                  queries:
                    type: array
                    items:
                      $ref: '#/components/schemas/QueryHistoryEntry'
                  total_count:
                    type: integer

  /api/session/export:
    post:
      tags: [session]
      summary: Export demo results
      description: |
        Export current session results in specified format (FR-023).
      operationId: exportResults
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                format:
                  type: string
                  enum: [json, csv]
                include_metrics:
                  type: boolean
                  default: true
              required:
                - format
      responses:
        '200':
          description: Exported data
          content:
            application/json:
              schema:
                type: object
            text/csv:
              schema:
                type: string

# ========================================
# COMPONENTS (Schemas, Responses, etc.)
# ========================================

components:
  schemas:
    FraudTransactionQuery:
      type: object
      required:
        - payer
        - amount
        - device
      properties:
        payer:
          type: string
          pattern: '^acct:.+'
          example: 'acct:user_12345'
        payee:
          type: string
          pattern: '^acct:.+'
          example: 'acct:merchant_789'
        amount:
          type: number
          format: decimal
          minimum: 0.01
          maximum: 1000000.00
          example: 1500.00
        device:
          type: string
          pattern: '^dev:.+'
          example: 'dev:laptop_001'
        merchant:
          type: string
          pattern: '^merch:.+'
          example: 'merch:store_789'
        ip_address:
          type: string
          format: ipv4
          example: '192.168.1.100'
        timestamp:
          type: string
          format: date-time

    FraudScoringResult:
      type: object
      properties:
        fraud_probability:
          type: number
          minimum: 0.0
          maximum: 1.0
          example: 0.92
        risk_classification:
          type: string
          enum: [low, medium, high, critical]
          example: 'critical'
        contributing_factors:
          type: array
          items:
            type: string
          example: ['High transaction amount', 'New device fingerprint']
        scoring_timestamp:
          type: string
          format: date-time
        scoring_model:
          type: string
          example: 'MLP'
        confidence:
          type: number
          minimum: 0.0
          maximum: 1.0
          example: 0.87

    BitemporalQuery:
      type: object
      required:
        - event_id
        - system_time
      properties:
        event_id:
          type: string
          example: 'txn_2025_001234'
        system_time:
          type: string
          format: date-time
          description: 'When did we know? (system time)'
        valid_time:
          type: string
          format: date-time
          description: 'When did it happen? (valid time)'
        query_mode:
          type: string
          enum: [as_of, diff, audit_trail]
          default: as_of

    BitemporalResult:
      type: object
      properties:
        event_id:
          type: string
        version_id:
          type: integer
        valid_from:
          type: string
          format: date-time
        valid_to:
          type: string
          format: date-time
          nullable: true
        system_from:
          type: string
          format: date-time
        system_to:
          type: string
          format: date-time
          nullable: true
        fraud_score:
          type: number
        fraud_status:
          type: string
          enum: [clean, suspicious, confirmed_fraud, reversed]
        changed_by:
          type: string
        change_reason:
          type: string
        data_snapshot:
          type: object

    BitemporalVersion:
      $ref: '#/components/schemas/BitemporalResult'

    LateArrivalTransaction:
      type: object
      properties:
        event_id:
          type: string
        valid_from:
          type: string
          format: date-time
        system_from:
          type: string
          format: date-time
        delay_hours:
          type: number
        amount:
          type: number
        payer:
          type: string
        device:
          type: string
        suspicion_flags:
          type: array
          items:
            type: string

    ProteinQuery:
      type: object
      properties:
        protein_identifier:
          type: string
          example: 'TP53'
        search_text:
          type: string
          example: 'tumor suppressor'
        search_mode:
          type: string
          enum: [vector_similarity, text_search, hybrid]
          default: hybrid
        top_k:
          type: integer
          minimum: 1
          maximum: 100
          default: 10
        min_similarity:
          type: number
          minimum: 0.0
          maximum: 1.0

    ProteinSearchResult:
      type: object
      properties:
        protein_id:
          type: string
        protein_name:
          type: string
        similarity_score:
          type: number
          minimum: 0.0
          maximum: 1.0
        interaction_count:
          type: integer
        metadata:
          type: object
        search_method:
          type: string
          enum: [vector, text, RRF_fusion, exact_match]

    PathwayQuery:
      type: object
      required:
        - source_protein
        - target_protein
      properties:
        source_protein:
          type: string
          example: 'TP53'
        target_protein:
          type: string
          example: 'MDM2'
        max_hops:
          type: integer
          minimum: 1
          maximum: 10
          default: 5
        algorithm:
          type: string
          enum: [shortest_path, all_paths, weighted_path]
          default: shortest_path

    InteractionNetwork:
      type: object
      properties:
        nodes:
          type: array
          items:
            $ref: '#/components/schemas/ProteinNode'
        edges:
          type: array
          items:
            $ref: '#/components/schemas/InteractionEdge'
        visualization_state:
          type: object
        layout_algorithm:
          type: string
          example: 'force_directed'

    ProteinNode:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        degree:
          type: integer
        cluster_id:
          type: integer
        x:
          type: number
        y:
          type: number

    InteractionEdge:
      type: object
      properties:
        source:
          type: string
        target:
          type: string
        interaction_type:
          type: string
          enum: [binds, activates, inhibits, phosphorylates]
        confidence:
          type: number
          minimum: 0.0
          maximum: 1.0

    QueryPerformanceMetrics:
      type: object
      properties:
        query_type:
          type: string
        execution_time_ms:
          type: integer
        backend_used:
          type: string
          enum: [fraud_api, iris_graph, cached_demo]
        result_count:
          type: integer
        search_methods:
          type: array
          items:
            type: string
        timestamp:
          type: string
          format: date-time

    QueryHistoryEntry:
      type: object
      properties:
        query_id:
          type: string
        query_type:
          type: string
          enum: [fraud_score, bitemporal, audit_trail, protein_search, pathway, hybrid_search]
        query_params:
          type: object
        result_summary:
          type: object
        timestamp:
          type: string
          format: date-time

  responses:
    ValidationError:
      description: Validation error
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
              details:
                type: object

    ServiceUnavailable:
      description: Backend service unavailable (using cached demo data)
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
              fallback_mode:
                type: string
                example: 'demo_data'
              message:
                type: string
                example: 'Backend API unavailable. Using cached demo data.'
